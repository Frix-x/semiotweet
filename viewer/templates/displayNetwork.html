{% extends "template.html" %}
{% block title %} | Keywords network {% endblock %}
{% load static %}

{% block content %}
<div class="section no-pad-bot" id="index-banner">
    <div class="container">
        <br><br>
        <h1 class="header center orange-text">Network</h1>
        <br><br>
    </div>
</div>

<div class="container">
    <div class="section">
        <div class="row">
          <div class="col s12 m12">
            <div class="icon-block">
              <div id="keywordsNetwork"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="{% static "js/utils.js" %}"></script>
<script src="{% static "js/d3.min.js" %}"></script>
<script type="text/javascript">
    $(document).ready(function() {
        var svg = d3.select("div#keywordsNetwork")
            .append("div")
            .classed("svg-container", true)
            .append("svg")
            .attr("preserveAspectRatio", "xMinYMin meet")
            .attr("viewBox", "0 0 600 400")
            .classed("svg-content-responsive", true);
        var width = +svg.attr("width"),
            height = +svg.attr("height");
        var color = d3.scaleOrdinal(d3.schemeCategory20);
        var simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(function(d) {
                return d.id;
            }))
            .force("charge", d3.forceManyBody())
            .force("center", d3.forceCenter(width / 2, height / 2));

        function dragstarted(d) {
            if (!d3.event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        }

        function dragended(d) {
            if (!d3.event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        $.get('/api/v1/nlp/network/tweets', function(res, status) {
            if (status === 'success') {
                var graph = res.network;
                var link = svg.append("g")
                    .attr("class", "links")
                    .selectAll("line")
                    .data(graph.edges)
                    .enter().append("line")
                    .attr("stroke-width", function(d) {
                        return Math.sqrt(d.value);
                    });
                var node = svg.append("g")
                    .attr("class", "nodes")
                    .selectAll("circle")
                    .data(graph.nodes)
                    .enter().append("circle")
                    .attr("r", 5)
                    .attr("fill", function(d) {
                        return color(d.group);
                    })
                    .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended));
                node.append("title")
                    .text(function(d) {
                        return d.id;
                    });
                simulation.nodes(graph.nodes).on("tick", ticked);
                simulation.force("link").links(graph.edges);

                function ticked() {
                    link.attr("x1", function(d) {
                            return d.source.x;
                        })
                        .attr("y1", function(d) {
                            return d.source.y;
                        })
                        .attr("x2", function(d) {
                            return d.target.x;
                        })
                        .attr("y2", function(d) {
                            return d.target.y;
                        });
                    node.attr("cx", function(d) {
                            return d.x;
                        })
                        .attr("cy", function(d) {
                            return d.y;
                        });
                }
            }
        });
    });
</script>
{% endblock %}
